#admintool function and usage

## install requirements

```
$ pip install -r requirements.txt
```

##The main function
Can be run by running the following command:
```
cd target/install
./bin/admintool.sh --help
```

Result
```
usage: ./admintool.sh -a admin_id -l ip_list -n consensus_name -m crypto_method -d block_duration -t
option:
-a admin_id    admin identifier
    default value is 'admin'

-l ip_list     list all the node's IP and port
    default value is '127.0.0.1:4000,127.0.0.1:4001,127.0.0.1:4002,127.0.0.1:4003'

-n consensus_name  name of consensus algorithm
    default value is 'tendermint', other is 'raft' and 'poa'

-m crypto_method    name of crypto algorithm
    default value is 'SECP'

-d block_duration    block generating duration(millisecond)
    default value is '3000'

-t            consensus test flag, only valid for tendermint

-h enable jsonrpc http
   default enable 'true'

-w enable jsonrpc websocket
   default enable 'false'

-P define jsonrpc HTTP port or websocket port
   default port is '1337' or '4337'

-k start with kafka

-Q singel node id


```
#The default initial configuration for the current four nodes, if need to be in the admintool.sh script ** initial configuration N nodes **, through the following orders, such as the allocation of five nodes
```
./bin/admintool.sh -l "127.0.0.1:4000,127.0.0.1:4001,127.0.0.1:4002,127.0.0.1:4003,127.0.0.1:4004"
```

## setup

```
./bin/admintool.sh
After running `node *` and backup backup folder will be generated.
  Node * contains node files and related configuration files, as follows:
- Generate a private key and address, private key stored in `node * / privkey`, where nodeID is the node number; and all node addresses are stored in` backup / authorities`;
- Generate a network configuration file, stored in `node * / network.toml`, the content of the file is mainly the total number of nodes, the local node port and other nodes ip and port number;
Generate genesis block file, stored in node * / genesis.json`, where timestamp is the timestamp in seconds; prevhash refers to the previous block hash, here is the default value; and alloc refers to the contract deployed to Genesis Block content;
- Generate the node configuration file, stored in `node * / consensus.json`, mainly contains the relevant parameters of the consensus algorithm;
- Generate jsonrpc configuration file, stored in `node * / jsonrpc.json`, mainly contains the relevant parameters of jsonrpc module.
  Backup file is stored for the single node to increase the backup information, there are authorities, genesis.json two documents, the role of the following [Add node separately]

## system contract

A system contract is a contract that is deployed to the chain to implement a specific function, starting from the genesis block. Its contract address is written in the genesis block and is a fixed address. CALKI major system contract node management contracts, quota management and rights management contracts.

### Initialize the system contract description

Users can choose to customize the system initialization contract data and use the system default data, which release file under the init_data.json to initialize the system contract data file.

#### User-defined initialization system contract data

Users can create init_data.json file in this directory to customize the system contract initialization data. Format reference `init_data_example.json` file, as follows:

```json
{
    "0x00000000000000000000000000000000013241a2": [[], ["0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523"]],
    "0x00000000000000000000000000000000013241a3": "0xd3f1a71d1d8f073f4e725f57bbe14d67da22f888",
    "0x00000000000000000000000000000000013241a4": [["0x1a702a25c6bca72b67987968f0bfb3a3213c5688"], ["0x0dbd369a741319fa5107733e2c9db9929093e3c7"]]
}
```


* `0x00000000000000000000000000000000013241a2`: On behalf of the consensus node management system contract address, the [] `` two-dimensional array for the node address list, generated by the system, ignore this option, the user can modify `[" 0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523 ]`The value generated for their own address,
                                                 It is the administrator address, which adds or deletes the consensus node. *** must save the corresponding private key ***

* `0x00000000000000000000000000000000013241a3`:On behalf of the quota management system contract address, the user can modify the address generated for `0xd3f1a71d1d8f073f4e725f57bbe14d67da22f888` value, which is the administrator address of the quota management,
                                                Quotas can be administered at this address. *** must save the corresponding private key ***

* `0x00000000000000000000000000000000013241a4`: On behalf of the rights management system contract address, the first array is the list of addresses that have the authority to send the transaction, the second is the list of addresses that have the authority to create the contract.
                                                Users can fill in multiple addresses respectively. *** must save the corresponding private key ***

#### Use the default initialization data

The user can use the system default initialization data, ie, the file init_data_example.json, with the address and its corresponding private key as shown in the following table:

|                          privkey                                 |                   address                  |
|:----------------------------------------------------------------:|:------------------------------------------:|
| 5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6 | 0x4b5ae4567ad5d9fb92bc9afd6a657e6fa13a2523 |
| 61b760173f6d6b87726a28b93d7fcb4b4f842224921de8fa8e49b983a3388c03 | 0xd3f1a71d1d8f073f4e725f57bbe14d67da22f888 |
| 866c936ff332228948bdefc15b1877c88e0effce703ee6de898cffcafe9bbe25 | 0x1a702a25c6bca72b67987968f0bfb3a3213c5688 |
| 352416e1c910e413768c51390dfd791b414212b7b4fe6b1a18f58007fa894214 | 0x0dbd369a741319fa5107733e2c9db9929093e3c7 |

#### User-defined check configuration file

Users can create a `chain.json` file in this directory to customize permission checking for accounts when sending transactions, etc. By default, it is checked. Format reference `chain_check_example.json` file, as follows:

```
{
  "check_permission": true,
  "check_quota": true
}
```
among them

* `check_permission`: When sending the transaction, whether to check whether the account has the corresponding permission, where true means to open the inspection, false means to close the inspection, the default is true.
* `check_quota`: When sending transaction, it is checked whether the gas and Account gas of the block exceed the upper limit, where true means open inspection, false means close inspection, the default is true.

### Node Management System Contract

The node management contract is stored in `install / scripts / contracts / node_manager.sol`. The function signature can be compiled with` solc node_manager.sol --hashes` or it can be found at [remix] (https://remix.ethereum.org) View on.
The details of the node_manager.sol contract are shown belowï¼š
```
contract address: 0x00000000000000000000000000000000013241a2
Function signatures:
    dd4c97a0: approveNode(address)
    2d4ede93: deleteNode(address)
    30ccebb5: getStatus(address)
    609df32f: listNode()
    ddad2ffe: newNode(address)
    645b8b1b: status(address)
```
The purpose of the node management contract is to be able to dynamically add and remove nodes, that is, to add or delete nodes in some already running nodes, which can be achieved by calling the method in the contract.
The contract node has three states: Close, Ready, Start, the initial default is Close, you can change the node state by calling the function in the contract.
For example, to add a node, the applicant first calls the newNode () method, and the approver (consensus node) calls approveNode to agree that the node becomes a consensus node. Here are some of the main ways under the contract:

- `` newNode (address) `", the function of this method is to apply to become a consensus node, where the address of the parameter represents the address of the requesting node. The caller invokes this method on the contract via calki_sendTransaction, and the node status changes to Ready.

- `approveNode (address)`, the function of this method agrees with it as a consensus node, where the address of the parameter indicates the address of the node whose status is Ready, and the approver (consensus node) passes the calki_sendTransaction
This method is called to agree with the node whose node status is Ready to join the consensus. In this case, the node status changes to Start.

- `deleteNode (address)`. The function of this method is to delete the consensus node, in which the address "address" represents the address of the node in the state "Start" and the node in the "Start" state can exit the consensus by calling this method on the contract via "calki_sendTransaction"
In this case, the node status changes to Close.


### Quota Management System Contract

The quota management contract is stored in `install / scripts / contracts / quota.sol` and the contract details are as follows:

```
contract address: 0x00000000000000000000000000000000013241a3
    70480275: addAdmin(address)
    dae99b3a: getAccountGasLimit()
    776dd3b6: getAccountQuota(address)
    54f6127f: getData(bytes32)
    6cf72948: getSpecialUsers()
    7a490f7e: getUsersQuota()
    3a5b5cf3: getblockGasLimit()
    24d7806c: isAdmin(address)
    dfa87425: setAccountGasLimit(address,uint256)
    a69257f3: setBlockGasLimit(uint256)
    eb93eddf: setGlobal(bytes32,bytes32)
    c9bcec77: setGlobalAccountGasLimit(uint256)
    748ba8dd: setIsGlobal(bytes32,bool)
    50f2ee97: setSpecial(address,bytes32,bytes32)
```
The quota management contract sets the gasLimit for each block and account, where gasLimit in the block effectively controls the number of transactions in that block, gasLimit in the account effectively controls the number of transactions the user has sent in the current block Obviously, gasLimit in account is equal to or less than gasLimit in block. The user is divided into specialUser and globalUser, the default value of gasLimit of specialUser is equal to gasLimit of block, that is, as long as the gasLimit of the block is not reached,
Can send any transaction. The globalUser gasLimit default value is much smaller than the block's gasLimit. In addition, there is an administrator account that sets the gasLimit for blocks and accounts.
The main methods of the contract are as follows:


addAdmin (address)`, the method is to add a management account, only the user who sends the transaction as an administrator can successfully add other users as administrators through calki_sendTransaction call.

- `setAccountGasLimit (address, uint256)`, This method sets the gasLimit of other users, and only caller_sendTransaction can be called successfully.

- `setBlockGasLimit (uint256)`, This method sets the gasLimit of the block so that only caller_sendTransaction can be called successfully.

- `getData (bytes32)`, which queries gasLimit for the user or block, and all addresses can successfully call this method via eth_call.

- `getSpecialUsers ()`, which queries all specical users and all addresses can successfully call this method via eth_call.

- `getUsersQuota ()`, which queries the gasLimit for the special user, which is the quota, all of which can be successfully called via eth_call.

- `getAccountQuota (address)`, This method queries the specified user corresponding gasLimit, quotas, all addresses can be successfully called eth_call this method.

- `getAccountGasLimit ()`, which queries for AccountGasLimit, a quota, and all addresses can successfully call this method via eth_call.

- `getblockGasLimit ()`, which queries blockGasLimit, the quota, and all addresses can successfully call this method via eth_call.
###Right Management System Contract

The rights management contract is stored in `install / scripts / contracts / permission_manager.sol`, which introduces rights management into the system to effectively control the user's trading permissions. Details of the contract are as follows:
```
contract address: 0x00000000000000000000000000000000013241a4
Function signatures:
    301da870: grantPermission(address,uint8)
    54ad6352: queryPermission(address)
    6f4eaf7a: queryUsersOfPermission(uint8)
    dd8a8a05: revokePermission(address,uint8)
```

At present, the rights management function of the contract is relatively simple, there are two kinds of permissions: send the transaction and create a contract (Send, Create). Each address by default does not have these two kinds of permissions, you can obtain one or two kinds of permissions through the authorized address.
For example, Grant Create permission, already has the Create permission address can call the grantPermission () method in the contract to grant Create permissions to other addresses.
The methods in the contract are described below:

 `grantPermission (address, uint8)`, This method is to grant some permission, where address is the address that the permission is given, uint8 is the name of the permission, and the address with the permission is
This method is called by calki_sendTransaction to grant this address to another address.

- `revokePermission (address, uint8)`, This method is to cancel a certain authority, in which the address address to cancel the authority address, uint8 authority name, the authority of the address
Call this method via calki_sendTransaction to deny this address to other addresses.

- `queryPermission (address)`, the method is to query the permissions of the specified address can be called by eth_call to query.

- `queryUsersOfPermission (uint8)`, which queries all users who have the specified permissions and can invoke the method via eth_call to query.


### Add nodes individually
The main principle: the new node first intervention as a read-only node, and then by sending authentication (transaction) to control the permissions of the new node.And increase the node alone need to rely on the existing node information such as: authorities, genesis.json

Steps:
1. Make sure the data is not corrupted. Copy the files install / backup, install / bin, install / scripts and their contents to another directory.
2. Run the command:
     `` `
     ./bin/admintool.sh -Q [nodeId]

      Such as ./bin/admintool.sh -Q 8
     `` `
    In the current directory will generate the specified node directory and related information, followed by the generation of the latest authorities file.
3. Configure node information, such as network.toml, jsonrpc.json and so on.
4. To ensure correct, correct procedures, backup the latest authorities documents.

